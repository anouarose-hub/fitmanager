<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>FIT MANAGER | Offres</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="sidebar-wrapper">
        <div class="dock-glass">
            <div class="brand"><i class="fas fa-crown"></i> FIT MANAGER</div>
            <nav class="d-flex flex-column">
                <a href="index.html" class="nav-item"><i class="fas fa-chart-pie"></i> Vue Globale</a>
                <a href="membres.html" class="nav-item"><i class="fas fa-users"></i> Membres</a>
                <a href="machines.html" class="nav-item"><i class="fas fa-dumbbell"></i> Parc Machine</a>
                <a href="coachs.html" class="nav-item"><i class="fas fa-user-astronaut"></i> Experts</a>
                <a href="paiements.html" class="nav-item"><i class="fas fa-credit-card"></i> Trésorerie</a>
                <a href="abonnements.html" class="nav-item active"><i class="fas fa-gem"></i> Offres</a>
            </nav>
        </div>
    </div>

    <div id="page-content">
        
        <div class="page-heading">
            <h1>Offres & Abonnements</h1>
            <p>Gestion des plans tarifaires et stratégies de prix.</p>
        </div>

        <div class="top-actions no-print">
            <button class="btn-custom" onclick="window.print()"><i class="fas fa-print me-2"></i>PDF</button>
            <button class="btn-gold" onclick="openModal()"><i class="fas fa-plus me-2"></i>Nouveau Plan</button>
        </div>

        <div class="table-wrapper">
            <table class="table" id="planTable">
                <thead>
                    <tr>
                        <th style="width: 15%">ID</th>
                        <th style="width: 45%">Nom de l'offre</th>
                        <th style="width: 25%">Prix Mensuel</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="entityModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Éditer une offre</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="entityForm">
                        <input type="hidden" id="planId">
                        
                        <div class="mb-3">
                            <label class="form-label">NOM DE L'OFFRE</label>
                            <input type="text" class="form-control" id="planName" required placeholder="Ex: Diamond">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">PRIX (€)</label>
                            <input type="number" class="form-control" id="planPrice" required placeholder="Ex: 90">
                        </div>

                        <button type="submit" class="btn-gold w-100 mt-2">ENREGISTRER</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data.js"></script>
    
    <script>
        let myModal = new bootstrap.Modal(document.getElementById('entityModal'));

        // --- GESTION DES COULEURS ---
        function getPlanColor(planName) {
            const name = planName.toLowerCase().trim();
            // Couleurs fixes pour l'identité de marque
            if (name.includes('standard')) return '#A0A0A0';
            if (name.includes('gold')) return '#FFD700';
            if (name.includes('platinum')) return '#25C2A0';
            if (name.includes('diamond')) return '#9B59B6';

            // Couleurs dynamiques pour les nouvelles offres
            const colors = ['#FF6B6B', '#4ECDC4', '#FF9F43', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        // --- AFFICHAGE DU TABLEAU ---
        function renderTable() {
            const data = getData('fit_plans');
            const tbody = document.querySelector('#planTable tbody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const color = getPlanColor(row.nom);
                
                tbody.innerHTML += `
                    <tr>
                        <td class="text-id">#${row.id}</td>
                        <td style="color:${color}; font-weight:700; text-transform:uppercase; letter-spacing:1px; font-size:1.05rem;">
                            <i class="fas fa-crown me-2"></i>${row.nom}
                        </td>
                        <td class="price-tag">${row.prix} €</td>
                        
                        <td class="text-end no-print">
                            <button class="btn btn-sm btn-silver me-2" onclick="editEntity(${row.id})" title="Modifier">
                                <i class="fas fa-pen"></i>
                            </button>
                            
                            <button class="btn btn-sm btn-red-glow" onclick="deleteEntity(${row.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- GESTION DU MODAL ---
        function openModal() { document.getElementById('entityForm').reset(); document.getElementById('planId').value = ''; myModal.show(); }
        
        function editEntity(id) {
            const item = getData('fit_plans').find(x => x.id === id);
            document.getElementById('planId').value = item.id;
            document.getElementById('planName').value = item.nom;
            document.getElementById('planPrice').value = item.prix;
            myModal.show();
        }

        function deleteEntity(id) {
            if(confirm('Supprimer cette offre ? Attention, cela n\'impacte pas les membres déjà inscrits.')) {
                saveData('fit_plans', getData('fit_plans').filter(x => x.id !== id));
                renderTable();
            }
        }

        // --- SAUVEGARDE & RÉTROACTIVITÉ (Le Point Fort) ---
        document.getElementById('entityForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let data = getData('fit_plans');
            const idParam = document.getElementById('planId').value;
            let finalId;

            const nomOffre = document.getElementById('planName').value;
            const nouveauPrix = parseFloat(document.getElementById('planPrice').value);

            // Gestion ID
            if (idParam) finalId = parseInt(idParam);
            else finalId = (data.length === 0) ? 1 : Math.max(...data.map(m => m.id)) + 1;

            const newItem = {
                id: finalId,
                nom: nomOffre,
                prix: nouveauPrix
            };

            if (idParam) {
                // MODIFICATION & MAGIE RÉTROACTIVE
                data[data.findIndex(x => x.id == idParam)] = newItem;

                // Mise à jour de l'historique des paiements
                let payments = getData('fit_payments');
                let countUpdated = 0;
                
                payments.forEach(pay => {
                    // Si le paiement concerne cette offre, on force le nouveau prix
                    if (pay.motif && pay.motif.includes(nomOffre)) {
                        pay.montant = nouveauPrix;
                        countUpdated++;
                    }
                });

                if(countUpdated > 0) {
                    saveData('fit_payments', payments);
                    console.log(`Mise à jour rétroactive : ${countUpdated} paiements modifiés.`);
                }

            } else {
                // Création simple
                data.push(newItem);
            }

            saveData('fit_plans', data);
            myModal.hide();
            renderTable();
        });

        renderTable();
    </script>
</body>
</html>